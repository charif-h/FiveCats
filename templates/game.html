<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>5 Cats Game - Partie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/game.css') }}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
    <script type="text/javascript">
        var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
        var timerDuration = {{timer}};  // Utiliser la valeur du timer depuis les options
        var distance = timerDuration;
        var answer_image = '{{img}}';
        var timerInterval;
        var isPaused = false;
        var isShowingExpired = false;
        var currentGameState = '{{game_state}}'; // Variable pour stocker l'√©tat actuel du jeu

        socket.on('connect', function () {
            console.log('Connected to the server');
            // Si l'√©tat initial est 'loading', d√©marrer le compte √† rebours
            if ('{{game_state}}' === 'loading') {
                updateInterface('loading');
                startCountdown();
            }

            
            // Demander une synchronisation imm√©diate
            setTimeout(function() {
                socket.emit('ping_game_state');
            }, 100);
        });

        socket.on('game_state_sync', function(data) {
            console.log('Game state sync received:', data.state, 'at', new Date(data.timestamp * 1000));
            updateInterface(data.state);
        });

        // Syst√®me de heartbeat pour v√©rifier la synchronisation toutes les 10 secondes
        setInterval(function() {
            socket.emit('ping_game_state');
        }, 10000);

        socket.on('recharging_countdown', function(data){
            if (document.getElementById('recharging_countdown_game')) {
                document.getElementById('recharging_countdown_game').innerHTML = data['count'];
            }
        });

        socket.on('show_correct_answer', function(data){
            var display = document.getElementById('correct_answer_display_game');
            if (display) {
                display.innerHTML = data['message'];
            }
        });

        socket.on('force_disconnect', function(){
            console.log('Game ended - disconnecting...');
            socket.disconnect();
            setTimeout(function() {
                window.location.href = '/';
            }, 2000);
        });

        socket.on('update_score', function (data) {
            document.getElementById('players_ranking').innerHTML = "";
            for(var i in data){
                p = data[i];
                document.getElementById('players_ranking').innerHTML += '<tr><td>' + p[0] + '</td><td><p id="' + p[0] + '_score">' + p[1] + '</p></td></tr>';
            }
        });

        socket.on('new_question', function(data){
            document.getElementById('qimage').src = "/static/movies/" + data['image'] + ".png";
            answer_image = data['image'];
            
            // Ne pas red√©marrer le timer si on affiche encore le message EXPIRED
            if (!isShowingExpired) {
                distance = timerDuration;  // Utiliser la dur√©e configur√©e
                // Red√©marrer le timer pour la nouvelle question seulement si en mode in_progress
                if (!isPaused && currentGameState === 'in_progress') {
                    startQuestionTimer();
                }
            } else {
                // Si on re√ßoit une nouvelle question pendant l'affichage EXPIRED,
                // juste mettre √† jour l'image mais garder le timer d'expiration
                console.log('New question received during EXPIRED display - updating image only');
            }
        });

        var countdownInterval;

        socket.on('game_state_changed', function(data){
            currentGameState = data['state']; // Mettre √† jour la variable d'√©tat
            updatePauseButton(data['state']);
            updateInterface(data['state']);
            handleGameStateChange(data['state']);
            
            // D√©marrer le compte √† rebours si l'√©tat passe √† 'loading'
            if (data['state'] === 'loading') {
                startCountdown();
            }
        });

        socket.on('game_finished', function(data){
            showGameFinishedScreen(data);
        });

        socket.on('game_reset', function(){
            location.reload();
        });

        function endGame() {
            if (confirm('√ätes-vous s√ªr de vouloir terminer le jeu ?')) {
                socket.emit('end_game', {'reason': 'manual'});
            }
        }

        function showGameFinishedScreen(data) {
            // Masquer l'interface de jeu
            document.getElementById('game_interface').style.display = 'none';
            document.getElementById('countdown_screen').style.display = 'none';
            
            // Cr√©er et afficher l'√©cran de fin
            var finishScreen = document.createElement('div');
            finishScreen.id = 'finish_screen';
            finishScreen.className = 'text-center';
            
            // D√©terminer si c'est une fin naturelle ou manuelle
            const isNaturalEnd = data.reason && ['no_more_images', 'target_reached'].includes(data.reason);
            
            finishScreen.innerHTML = `
                <h1 class="mb-4" style="color: #ffd700;">
                    <i class="fa-solid fa-trophy"></i> Jeu Termin√© !
                </h1>
                ${data.winner ? `
                    <h2 class="mb-4" style="color: #4CAF50;">
                        üèÜ Gagnant: ${data.winner.name} (${data.winner.score} points)
                    </h2>
                ` : ''}
                <p class="lead mb-4">${data.message}</p>
                <div class="mb-5">
                    <h3>Scores finaux:</h3>
                    <table class="table table-striped mx-auto" style="max-width: 400px;">
                        <thead>
                            <tr><th>Joueur</th><th>Score</th></tr>
                        </thead>
                        <tbody>
                            ${data.final_scores.map(score => 
                                `<tr><td>${score[0]}</td><td>${score[1]}</td></tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
                ${!isNaturalEnd ? `
                    <button class="btn btn-success btn-lg me-3" onclick="resetGame()">
                        <i class="fa-solid fa-redo"></i> Nouveau Jeu
                    </button>
                    <button class="btn btn-secondary btn-lg" onclick="goHome()">
                        <i class="fa-solid fa-home"></i> Accueil
                    </button>
                ` : `
                    <div class="mt-4">
                        <p class="text-muted">Merci d'avoir jou√© !</p>
                        <small class="text-muted">Cette fen√™tre se fermera automatiquement dans quelques secondes...</small>
                    </div>
                `}
            `;
            
            document.querySelector('.game-container').appendChild(finishScreen);
            
            // Pour les fins naturelles, fermer automatiquement apr√®s 8 secondes
            if (isNaturalEnd) {
                setTimeout(() => {
                    window.close();
                }, 8000);
            }
        }

        function resetGame() {
            if (confirm('D√©marrer un nouveau jeu ? (Les scores seront remis √† z√©ro)')) {
                socket.emit('reset_game');
            }
        }

        function goHome() {
            window.location.href = '/';
        }

        function handleGameStateChange(state) {
            if (state === 'paused') {
                isPaused = true;
                pauseTimer();
                applyPausedEffect();
                socket.emit('game_paused');
            } else if (state === 'in_progress') {
                if (isPaused) {
                    // Reprendre apr√®s une pause
                    isPaused = false;
                    resumeTimer();
                    removePausedEffect();
                    socket.emit('game_resumed');
                } else {
                    // Premier passage √† in_progress - d√©marrer le timer
                    isPaused = false;
                    startQuestionTimer();
                }
            }
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function resumeTimer() {
            startQuestionTimer();
        }

        function applyPausedEffect() {
            var image = document.getElementById('qimage');
            if (image) {
                image.classList.add('paused-image');
                
                // Ajouter overlay de pause
                var container = image.parentElement;
                if (!document.getElementById('pause-overlay')) {
                    var overlay = document.createElement('div');
                    overlay.id = 'pause-overlay';
                    overlay.className = 'paused-overlay';
                    overlay.innerHTML = '<i class="fa-solid fa-pause"></i> JEU EN PAUSE';
                    container.style.position = 'relative';
                    container.appendChild(overlay);
                }
            }
        }

        function removePausedEffect() {
            var image = document.getElementById('qimage');
            if (image) {
                image.classList.remove('paused-image');
                
                // Supprimer overlay de pause
                var overlay = document.getElementById('pause-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
        }

        socket.on('countdown_update', function(data){
            if (document.getElementById('countdown_number')) {
                document.getElementById('countdown_number').innerHTML = data['count'];
            }
        });

        // L'√©tat initial est d√©j√† 'loading', pas besoin de l'√©mettre √† nouveau

        function startCountdown() {
            // √âviter de d√©marrer plusieurs comptes √† rebours
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            var countdown = 5;
            document.getElementById('countdown_number').innerHTML = countdown;
            socket.emit('countdown_update', {'count': countdown});
            
            countdownInterval = setInterval(function() {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('countdown_number').innerHTML = countdown;
                    socket.emit('countdown_update', {'count': countdown});
                } else {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    socket.emit('change_game_state', {'state': 'in_progress'});
                }
            }, 1000);
        }

        function updateInterface(state) {
            console.log('Updating game interface to state:', state);
            
            if (state === 'loading') {
                document.getElementById('countdown_screen').style.display = 'block';
                document.getElementById('game_interface').style.display = 'none';
                document.getElementById('recharging_screen').style.display = 'none';
            } else if (state === 'recharging') {
                document.getElementById('countdown_screen').style.display = 'none';
                document.getElementById('game_interface').style.display = 'none';
                document.getElementById('recharging_screen').style.display = 'block';
            } else if (state === 'finished') {
                document.getElementById('countdown_screen').style.display = 'none';
                document.getElementById('game_interface').style.display = 'none';
                document.getElementById('recharging_screen').style.display = 'none';
                // L'√©cran de fin sera g√©r√© par un autre √©v√©nement
            } else {
                // in_progress, waiting, paused
                document.getElementById('countdown_screen').style.display = 'none';
                document.getElementById('recharging_screen').style.display = 'none';
                document.getElementById('game_interface').style.display = 'block';
            }
            
            updatePauseButton(state);
        }

        // Fonction pour basculer entre pause et continue
        function togglePause() {
            if (currentGameState === 'in_progress' || currentGameState === 'recharging') {
                socket.emit('game_paused');
            } else if (currentGameState === 'paused') {
                socket.emit('game_resumed');
            }
        }

        // Fonction pour mettre √† jour l'apparence du bouton selon l'√©tat
        function updatePauseButton(state) {
            var pauseBtn = document.getElementById('pauseBtn');
            if (state === 'in_progress') {
                pauseBtn.style.display = 'block';
                pauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
                pauseBtn.className = 'btn btn-warning btn-lg';
            } else if (state === 'paused') {
                pauseBtn.style.display = 'block';
                pauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> Continue';
                pauseBtn.className = 'btn btn-success btn-lg';
            } else {
                pauseBtn.style.display = 'none';
            }
        }

        function startQuestionTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(function() {
                if (isPaused) {
                    return; // Ne pas d√©cr√©menter si en pause
                }
                
                document.getElementById("prog-timer").innerHTML = distance + "s ";
                document.getElementById("prog-timer").setAttribute('aria-valuenow', distance);
                document.getElementById("prog-timer").setAttribute('style', 'width:'+Number(100*distance/timerDuration)+'%');
                document.getElementById("prog-timer").setAttribute('class', 'progress-bar');

                if (distance <= 5){
                    document.getElementById("prog-timer").setAttribute('class', 'progress-bar bg-danger');
                }
                if (distance == 0){
                    socket.emit('time_out');
                }
                if (distance < 0) {
                    isShowingExpired = true;
                    document.getElementById("prog-timer").setAttribute('class', 'progress-bar bg-info');
                    document.getElementById("prog-timer").setAttribute('aria-valuenow', 6 + distance);
                    document.getElementById("prog-timer").setAttribute('style', 'width:'+Number(100*(6 + distance)/5)+'%');
                    
                    // Afficher le label EXPIRED et r√©duire l'opacit√© de l'image
                    document.getElementById("expired-text").innerHTML = "EXPIRED:<br> the answer is:<br> <b>" + answer_image + "</b>";
                    document.getElementById("expired-text").style.display = "block";
                    document.getElementById("qimage").classList.add("expired-image");
                }

                if (distance < -5) {
                    clearInterval(timerInterval);
                    isShowingExpired = false;
                    // R√©initialiser les styles apr√®s avoir affich√© la r√©ponse pendant 5 secondes
                    document.getElementById("expired-text").style.display = "none";
                    document.getElementById("qimage").classList.remove("expired-image");
                    
                    // Attendre la nouvelle question du serveur
                    document.getElementById("prog-timer").innerHTML = "NOUVELLE QUESTION...";
                    
                    // R√©initialiser le timer pour la prochaine question
                    distance = timerDuration;  // Utiliser la dur√©e configur√©e
                    
                    // Si une nouvelle question est en attente, la d√©marrer maintenant
                    setTimeout(function() {
                        if (!isPaused && currentGameState === 'in_progress') {
                            startQuestionTimer();
                        }
                    }, 1000);
                }
                distance -= 1;
            }, 1000);
        }

        // Le timer de question sera d√©marr√© quand l'√©tat passera √† 'in_progress'
    </script>
</head>
<body>
<div class="game-container">
    <!-- √âcran de compte √† rebours -->
    <div id="countdown_screen" class="text-center" {% if game_state == 'loading' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
        <h1 class="mb-4"><i class="fa-solid fa-clock"></i> Le jeu commence dans...</h1>
        <div id="countdown_number" class="display-1 text-warning mb-4" style="font-size: 8rem; font-weight: bold; text-shadow: 3px 3px 6px #000;">5</div>
        <p class="lead">Pr√©parez-vous !</p>
    </div>

    <!-- √âcran de recharging -->
    <div id="recharging_screen" class="text-center" style="display: none;">
        <h1 class="mb-4"><i class="fa-solid fa-refresh"></i> Question termin√©e !</h1>
        <div id="correct_answer_display_game" class="mb-4" style="color: #4CAF50; font-size: 2rem; font-weight: bold;"></div>
        <div id="recharging_countdown_game" class="display-1 text-info mb-4" style="font-size: 6rem; font-weight: bold; text-shadow: 3px 3px 6px #000;">5</div>
        <p class="lead">Prochaine question dans...</p>
    </div>

    <!-- Interface principale du jeu -->
    <div id="game_interface" {% if game_state == 'loading' %}style="display: none;"{% endif %}>
        <div class="row">
            <div class="col-md-4">
                <h1><i class="fa-solid fa-cat"></i> Joueurs</h1>
                <table class="table table-striped">
                    <thead>
                      <tr>
                        <th><i class="fa-solid fa-user"></i> Joueur</th>
                        <th><i class="fa-solid fa-star"></i> Score</th>
                      </tr>
                    </thead>
                    <tbody id="players_ranking">
                      {% for r in players %}
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            {% if r[2] %}
                       <img src="{{ url_for('static', filename='avatars/' + r[2]) }}" 
                           alt="Avatar" 
                           class="player-avatar me-2" 
                           data-player-name="{{ r[0] }}"
                           style="width: 48px; height: 48px; border-radius: 50%; cursor: pointer;"
                           title="Voir le profil de {{ r[0] }}"
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                       <i class="fa-solid fa-user me-2" style="display: none; width: 48px; text-align: center; cursor: pointer;" 
                         data-player-name="{{ r[0] }}" title="Voir le profil de {{ r[0] }}"></i>
                            {% else %}
                            <i class="fa-solid fa-user me-2" style="width: 32px; text-align: center; cursor: pointer;" 
                               data-player-name="{{ r[0] }}" title="Voir le profil de {{ r[0] }}"></i>
                            {% endif %}
                            <span>{{ r[0] }}</span>
                          </div>
                        </td>
                        <td><p id="{{ r[0] }}_score">{{ r[1] }}</p></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                </table>
                
                <!-- Boutons de contr√¥le sous la liste des joueurs -->
                <div class="mt-3">
                    <button id="pauseBtn" class="btn btn-warning btn-lg w-100 mb-2" onclick="togglePause()" style="display: none;">
                        <i class="fa-solid fa-pause"></i> Pause
                    </button>
                    <button id="endGameBtn" class="btn btn-danger btn-lg w-100 mb-2" onclick="endGame()">
                        <i class="fa-solid fa-flag-checkered"></i> Terminer
                    </button>
                </div>
            </div>
            <div class="col-md-8">
                <h1 class="mb-3 text-center"><i class="fa-solid fa-question"></i> Question</h1>
                <div class="progress mb-3">
                    <div class="progress-bar" id="prog-timer" role="progressbar" aria-valuenow="{{timer}}" aria-valuemin="0" aria-valuemax="{{timer}}"></div>
                </div>
                <div class="image-container text-center">
                    <div id="expired-text" class="expired-label">EXPIRED</div>
                    <img id="qimage" src="/static/movies/{{img}}.png" alt="Question Image" style="max-width: 100%; height: auto;"/>
                </div>
            </div>
        </div>
    </div> <!-- fin game_interface -->

    <!-- Carte modale pour le profil joueur -->
    <div id="playerProfileCard" class="card text-dark" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); min-width:400px; z-index:9999; max-width:500px;">
      <div class="card-header bg-primary text-white text-center">
        <span id="cardPlayerName" style="font-weight:bold;"></span>
        <button type="button" class="btn-close btn-close-white float-end" aria-label="Close" onclick="closePlayerProfileCard()"></button>
      </div>
      <div class="card-body text-center">
        <div class="mb-3">
          <img id="cardPlayerAvatar" src="" alt="Avatar" style="width:150px; height:150px; border-radius:50%; border: 3px solid #0d6efd;">
        </div>
        <div class="row mb-3">
          <div class="col-6">
            <div class="card bg-light">
              <div class="card-body p-2">
                <h6 class="card-title mb-1">Score</h6>
                <h4 class="text-primary mb-0" id="cardPlayerScore">0</h4>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="card bg-light">
              <div class="card-body p-2">
                <h6 class="card-title mb-1">Classement</h6>
                <h4 class="text-success mb-0" id="cardPlayerRanking">#1</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <h6>QR Code</h6>
          <div class="qr-bg d-inline-block">
            <img id="cardPlayerQR" src="" style="width:120px;">
          </div>
        </div>
      </div>
    </div>
    <div id="cardProfileOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9998;" onclick="closePlayerProfileCard()"></div>

</div>

<script>
    // G√©rer les clics sur les avatars
    document.addEventListener('DOMContentLoaded', function() {
        attachAvatarClickHandlers();
    });

    function attachAvatarClickHandlers() {
        document.querySelectorAll('.player-avatar').forEach(function(avatar) {
            avatar.addEventListener('click', function(e) {
                e.preventDefault();
                const playerName = this.getAttribute('data-player-name');
                showPlayerProfileCard(playerName);
            });
        });
    }

    function showPlayerProfileCard(playerName) {
        // R√©cup√©rer les d√©tails du joueur via API
        fetch(`/api/player-details/${playerName}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }
                
                // Remplir la carte avec les donn√©es
                document.getElementById('cardPlayerName').textContent = data.name;
                document.getElementById('cardPlayerAvatar').src = `/static/avatars/${data.avatar}`;
                document.getElementById('cardPlayerScore').textContent = data.score;
                document.getElementById('cardPlayerRanking').textContent = `#${data.ranking}`;
                document.getElementById('cardPlayerQR').src = data.qrcode;
                
                // Afficher la carte
                document.getElementById('playerProfileCard').style.display = 'block';
                document.getElementById('cardProfileOverlay').style.display = 'block';
            })
            .catch(error => {
                console.error('Erreur lors de la r√©cup√©ration des d√©tails du joueur:', error);
            });
    }

    function closePlayerProfileCard() {
        document.getElementById('playerProfileCard').style.display = 'none';
        document.getElementById('cardProfileOverlay').style.display = 'none';
    }

    // Mettre √† jour les avatars quand les scores sont mis √† jour
    const originalUpdateScore = window.updateScore || function() {};
    
    socket.on('update_score', function (data) {
        document.getElementById('players_ranking').innerHTML = "";
        for(var i in data){
            p = data[i];
            const avatarImg = p[2] ? 
                `<img src="/static/avatars/${p[2]}" alt="Avatar" class="player-avatar me-2" data-player-name="${p[0]}" style="width: 48px; height: 48px; border-radius: 50%; cursor: pointer;" title="Voir le profil de ${p[0]}">` : 
                '<i class="fa-solid fa-user me-2" style="width: 48px; text-align: center;"></i>';
            
            document.getElementById('players_ranking').innerHTML += 
                `<tr>
                    <td>
                        <div class="d-flex align-items-center">
                            ${avatarImg}
                            <span>${p[0]}</span>
                        </div>
                    </td>
                    <td><p id="${p[0]}_score">${p[1]}</p></td>
                </tr>`;
        }
        // R√©attacher les gestionnaires d'√©v√©nements
        attachAvatarClickHandlers();
    });
</script>