<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>5 Cats Game - Partie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: url('static/backgrounds/cats-bg.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }
        .game-container {
            background: rgba(34, 34, 34, 0.85);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            margin: 40px auto;
            padding: 30px;
            max-width: 1200px;
        }
        h1 {
            font-family: 'Luckiest Guy', cursive;
            font-size: 2.2rem;
            letter-spacing: 2px;
            color: #ffd700;
            text-shadow: 2px 2px 8px #222;
        }
        .table {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
        }
        th, td {
            color: #fff;
            vertical-align: middle;
        }
        .progress {
            height: 40px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .progress-bar {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(90deg, #ff9800 0%, #ff5e62 100%);
            border-radius: 10px;
            transition: width 0.5s;
        }
        .progress-bar.bg-danger {
            background: linear-gradient(90deg, #ff5e62 0%, #ff9800 100%);
        }
        .progress-bar.bg-info {
            background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
        }
        #qimage {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
            background: #222;
            padding: 10px;
        }
        .fa-cat {
            color: #ff9800;
            margin-right: 10px;
        }
        .image-container {
            position: relative;
            display: inline-block;
        }

        .expired-label {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 2;
        }

        .expired-image {
            opacity: 0.2;
            transition: opacity 0.5s ease;
        }
        #pauseBtn {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 140px;
        }
        #pauseBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .paused-image {
            filter: blur(10px);
            opacity: 0.3;
            transition: all 0.5s ease;
        }
        .paused-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            text-shadow: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            z-index: 10;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
    <script type="text/javascript">
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        var distance = 30;
        var answer_image = '{{img}}';
        var timerInterval;
        var isPaused = false;
        var isShowingExpired = false;

        socket.on('connect', function () {
            console.log('Connected to the server');
            // Si l'√©tat initial est 'loading', d√©marrer le compte √† rebours
            if ('{{game_state}}' === 'loading') {
                updateInterface('loading');
                startCountdown();
            }

            
            // Demander une synchronisation imm√©diate
            setTimeout(function() {
                socket.emit('ping_game_state');
            }, 100);
        });

        socket.on('game_state_sync', function(data) {
            console.log('Game state sync received:', data.state, 'at', new Date(data.timestamp * 1000));
            updateInterface(data.state);
        });

        // Syst√®me de heartbeat pour v√©rifier la synchronisation toutes les 10 secondes
        setInterval(function() {
            socket.emit('ping_game_state');
        }, 10000);

        socket.on('recharging_countdown', function(data){
            if (document.getElementById('recharging_countdown_game')) {
                document.getElementById('recharging_countdown_game').innerHTML = data['count'];
            }
        });

        socket.on('show_correct_answer', function(data){
            var display = document.getElementById('correct_answer_display_game');
            if (display) {
                display.innerHTML = data['message'];
            }
        });

        socket.on('force_disconnect', function(){
            console.log('Game ended - disconnecting...');
            socket.disconnect();
            setTimeout(function() {
                window.location.href = '/';
            }, 2000);
        });

        socket.on('update_score', function (data) {
            document.getElementById('players_ranking').innerHTML = "";
            for(var i in data){
                p = data[i];
                document.getElementById('players_ranking').innerHTML += '<tr><td>' + p[0] + '</td><td><p id="' + p[0] + '_score">' + p[1] + '</p></td></tr>';
            }
        });

        socket.on('new_question', function(data){
            document.getElementById('qimage').src = "/static/movies/" + data['image'] + ".png";
            answer_image = data['image'];
            
            // Ne pas red√©marrer le timer si on affiche encore le message EXPIRED
            if (!isShowingExpired) {
                distance = 30;
                // Red√©marrer le timer pour la nouvelle question seulement si en mode in_progress
                var currentState = document.getElementById('game_state_display').innerHTML;
                if (!isPaused && currentState === 'in_progress') {
                    startQuestionTimer();
                }
            } else {
                // Si on re√ßoit une nouvelle question pendant l'affichage EXPIRED,
                // juste mettre √† jour l'image mais garder le timer d'expiration
                console.log('New question received during EXPIRED display - updating image only');
            }
        });

        var countdownInterval;

        socket.on('game_state_changed', function(data){
            document.getElementById('game_state_display').innerHTML = data['state'];
            updatePauseButton(data['state']);
            updateInterface(data['state']);
            handleGameStateChange(data['state']);
            
            // D√©marrer le compte √† rebours si l'√©tat passe √† 'loading'
            if (data['state'] === 'loading') {
                startCountdown();
            }
        });

        socket.on('game_finished', function(data){
            showGameFinishedScreen(data);
        });

        socket.on('game_reset', function(){
            location.reload();
        });

        function endGame() {
            if (confirm('√ätes-vous s√ªr de vouloir terminer le jeu ?')) {
                socket.emit('end_game', {'reason': 'manual'});
            }
        }

        function showGameFinishedScreen(data) {
            // Masquer l'interface de jeu
            document.getElementById('game_interface').style.display = 'none';
            document.getElementById('countdown_screen').style.display = 'none';
            
            // Cr√©er et afficher l'√©cran de fin
            var finishScreen = document.createElement('div');
            finishScreen.id = 'finish_screen';
            finishScreen.className = 'text-center';
            finishScreen.innerHTML = `
                <h1 class="mb-4" style="color: #ffd700;">
                    <i class="fa-solid fa-trophy"></i> Jeu Termin√© !
                </h1>
                ${data.winner ? `
                    <h2 class="mb-4" style="color: #4CAF50;">
                        üèÜ Gagnant: ${data.winner.name} (${data.winner.score} points)
                    </h2>
                ` : ''}
                <p class="lead mb-4">${data.message}</p>
                <div class="mb-4">
                    <h3>Scores finaux:</h3>
                    <table class="table table-striped mx-auto" style="max-width: 400px;">
                        <thead>
                            <tr><th>Joueur</th><th>Score</th></tr>
                        </thead>
                        <tbody>
                            ${data.final_scores.map(score => 
                                `<tr><td>${score[0]}</td><td>${score[1]}</td></tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-success btn-lg me-3" onclick="resetGame()">
                    <i class="fa-solid fa-redo"></i> Nouveau Jeu
                </button>
                <button class="btn btn-secondary btn-lg" onclick="goHome()">
                    <i class="fa-solid fa-home"></i> Accueil
                </button>
            `;
            
            document.querySelector('.game-container').appendChild(finishScreen);
        }

        function resetGame() {
            if (confirm('D√©marrer un nouveau jeu ? (Les scores seront remis √† z√©ro)')) {
                socket.emit('reset_game');
            }
        }

        function goHome() {
            window.location.href = '/';
        }

        function handleGameStateChange(state) {
            if (state === 'paused') {
                isPaused = true;
                pauseTimer();
                applyPausedEffect();
                socket.emit('game_paused');
            } else if (state === 'in_progress') {
                if (isPaused) {
                    // Reprendre apr√®s une pause
                    isPaused = false;
                    resumeTimer();
                    removePausedEffect();
                    socket.emit('game_resumed');
                } else {
                    // Premier passage √† in_progress - d√©marrer le timer
                    isPaused = false;
                    startQuestionTimer();
                }
            }
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function resumeTimer() {
            startQuestionTimer();
        }

        function applyPausedEffect() {
            var image = document.getElementById('qimage');
            if (image) {
                image.classList.add('paused-image');
                
                // Ajouter overlay de pause
                var container = image.parentElement;
                if (!document.getElementById('pause-overlay')) {
                    var overlay = document.createElement('div');
                    overlay.id = 'pause-overlay';
                    overlay.className = 'paused-overlay';
                    overlay.innerHTML = '<i class="fa-solid fa-pause"></i> JEU EN PAUSE';
                    container.style.position = 'relative';
                    container.appendChild(overlay);
                }
            }
        }

        function removePausedEffect() {
            var image = document.getElementById('qimage');
            if (image) {
                image.classList.remove('paused-image');
                
                // Supprimer overlay de pause
                var overlay = document.getElementById('pause-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
        }

        socket.on('countdown_update', function(data){
            if (document.getElementById('countdown_number')) {
                document.getElementById('countdown_number').innerHTML = data['count'];
            }
        });

        // L'√©tat initial est d√©j√† 'loading', pas besoin de l'√©mettre √† nouveau

        function startCountdown() {
            // √âviter de d√©marrer plusieurs comptes √† rebours
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            var countdown = 5;
            document.getElementById('countdown_number').innerHTML = countdown;
            socket.emit('countdown_update', {'count': countdown});
            
            countdownInterval = setInterval(function() {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('countdown_number').innerHTML = countdown;
                    socket.emit('countdown_update', {'count': countdown});
                } else {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    socket.emit('change_game_state', {'state': 'in_progress'});
                }
            }, 1000);
        }

        function updateInterface(state) {
            console.log('Updating game interface to state:', state);
            
            if (state === 'loading') {
                document.getElementById('countdown_screen').style.display = 'block';
                document.getElementById('game_interface').style.display = 'none';
                document.getElementById('recharging_screen').style.display = 'none';
            } else if (state === 'recharging') {
                document.getElementById('countdown_screen').style.display = 'none';
                document.getElementById('game_interface').style.display = 'none';
                document.getElementById('recharging_screen').style.display = 'block';
            } else if (state === 'finished') {
                document.getElementById('countdown_screen').style.display = 'none';
                document.getElementById('game_interface').style.display = 'none';
                document.getElementById('recharging_screen').style.display = 'none';
                // L'√©cran de fin sera g√©r√© par un autre √©v√©nement
            } else {
                // in_progress, waiting, paused
                document.getElementById('countdown_screen').style.display = 'none';
                document.getElementById('recharging_screen').style.display = 'none';
                document.getElementById('game_interface').style.display = 'block';
            }
            
            updatePauseButton(state);
        }

        // Fonction pour basculer entre pause et continue
        function togglePause() {
            var currentState = document.getElementById('game_state_display').innerHTML;
            if (currentState === 'in_progress' || currentState === 'recharging') {
                socket.emit('game_paused');
            } else if (currentState === 'paused') {
                socket.emit('game_resumed');
            }
        }

        // Fonction pour mettre √† jour l'apparence du bouton selon l'√©tat
        function updatePauseButton(state) {
            var pauseBtn = document.getElementById('pauseBtn');
            if (state === 'in_progress') {
                pauseBtn.style.display = 'block';
                pauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
                pauseBtn.className = 'btn btn-warning btn-lg';
            } else if (state === 'paused') {
                pauseBtn.style.display = 'block';
                pauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> Continue';
                pauseBtn.className = 'btn btn-success btn-lg';
            } else {
                pauseBtn.style.display = 'none';
            }
        }

        function startQuestionTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(function() {
                if (isPaused) {
                    return; // Ne pas d√©cr√©menter si en pause
                }
                
                document.getElementById("prog-timer").innerHTML = distance + "s ";
                document.getElementById("prog-timer").setAttribute('aria-valuenow', distance);
                document.getElementById("prog-timer").setAttribute('style', 'width:'+Number(100*distance/30)+'%');
                document.getElementById("prog-timer").setAttribute('class', 'progress-bar');

                if (distance <= 5){
                    document.getElementById("prog-timer").setAttribute('class', 'progress-bar bg-danger');
                }
                if (distance == 0){
                    socket.emit('time_out');
                }
                if (distance < 0) {
                    isShowingExpired = true;
                    document.getElementById("prog-timer").setAttribute('class', 'progress-bar bg-info');
                    document.getElementById("prog-timer").setAttribute('aria-valuenow', 6 + distance);
                    document.getElementById("prog-timer").setAttribute('style', 'width:'+Number(100*(6 + distance)/5)+'%');
                    
                    // Afficher le label EXPIRED et r√©duire l'opacit√© de l'image
                    document.getElementById("expired-text").innerHTML = "EXPIRED:<br> the answer is:<br> <b>" + answer_image + "</b>";
                    document.getElementById("expired-text").style.display = "block";
                    document.getElementById("qimage").classList.add("expired-image");
                }

                if (distance < -5) {
                    clearInterval(timerInterval);
                    isShowingExpired = false;
                    // R√©initialiser les styles apr√®s avoir affich√© la r√©ponse pendant 5 secondes
                    document.getElementById("expired-text").style.display = "none";
                    document.getElementById("qimage").classList.remove("expired-image");
                    
                    // Attendre la nouvelle question du serveur
                    document.getElementById("prog-timer").innerHTML = "NOUVELLE QUESTION...";
                    
                    // R√©initialiser le timer pour la prochaine question
                    distance = 30;
                    
                    // Si une nouvelle question est en attente, la d√©marrer maintenant
                    setTimeout(function() {
                        var currentState = document.getElementById('game_state_display').innerHTML;
                        if (!isPaused && currentState === 'in_progress') {
                            startQuestionTimer();
                        }
                    }, 1000);
                }
                distance -= 1;
            }, 1000);
        }

        // Le timer de question sera d√©marr√© quand l'√©tat passera √† 'in_progress'
    </script>
</head>
<body>
<div class="game-container">
    <!-- √âcran de compte √† rebours -->
    <div id="countdown_screen" class="text-center" {% if game_state == 'loading' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
        <h1 class="mb-4"><i class="fa-solid fa-clock"></i> Le jeu commence dans...</h1>
        <div id="countdown_number" class="display-1 text-warning mb-4" style="font-size: 8rem; font-weight: bold; text-shadow: 3px 3px 6px #000;">5</div>
        <p class="lead">Pr√©parez-vous !</p>
    </div>

    <!-- √âcran de recharging -->
    <div id="recharging_screen" class="text-center" style="display: none;">
        <h1 class="mb-4"><i class="fa-solid fa-refresh"></i> Question termin√©e !</h1>
        <div id="correct_answer_display_game" class="mb-4" style="color: #4CAF50; font-size: 2rem; font-weight: bold;"></div>
        <div id="recharging_countdown_game" class="display-1 text-info mb-4" style="font-size: 6rem; font-weight: bold; text-shadow: 3px 3px 6px #000;">5</div>
        <p class="lead">Prochaine question dans...</p>
    </div>

    <!-- Interface principale du jeu -->
    <div id="game_interface" class="row" {% if game_state == 'loading' %}style="display: none;"{% endif %}>
        <div class="col-md-4">
            <h1><i class="fa-solid fa-cat"></i> Joueurs</h1>
            <div class="alert alert-info text-center mb-3">
                <i class="fa-solid fa-info-circle"></i> √âtat du jeu: <strong id="game_state_display">{{ game_state }}</strong>
            </div>
            <table class="table table-striped">
                <thead>
                  <tr>
                    <th><i class="fa-solid fa-user"></i> Nom</th>
                    <th><i class="fa-solid fa-star"></i> Score</th>
                  </tr>
                </thead>
                <tbody id="players_ranking">
                  {% for r in players %}
                  <tr>
                    <td>{{ r[0] }}</td>
                    <td><p id="{{ r[0] }}_score">{{ r[1] }}</p></td>
                  </tr>
                  {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-md-8 text-center">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1><i class="fa-solid fa-question"></i> Question</h1>
                <div>
                    <button id="pauseBtn" class="btn btn-warning btn-lg me-2" onclick="togglePause()" style="display: none;">
                        <i class="fa-solid fa-pause"></i> Pause
                    </button>
                    <button id="endGameBtn" class="btn btn-danger btn-lg" onclick="endGame()">
                        <i class="fa-solid fa-flag-checkered"></i> Terminer
                    </button>
                </div>
            </div>
            <div class="progress mb-3">
                <div class="progress-bar" id="prog-timer" role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="30"></div>
            </div>
            <div class="image-container">
                <div id="expired-text" class="expired-label">EXPIRED</div>
                <img id="qimage" src="/static/movies/{{img}}.png" alt="Question Image"/>
            </div>
        </div>
    </div> <!-- fin game_interface -->
</div>
</body>
</html>