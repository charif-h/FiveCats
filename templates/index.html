<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>5 Cats Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/index.css') }}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
</head>
<body>
    <div class="container-fluid p-3 my-3">
        <div class="row gx-4">
            <!-- Colonne de gauche : Options -->
            <div class="col-4">
                <div class="options-panel p-4 border">
                    <!-- Logo en haut -->
                    <div class="text-center mb-4">
                        <img id="logo" src="static/logo-cat.png" alt="5 Cats Game Logo">
                    </div>
                    
                    <!-- Options en dessous -->
                    <div class="options-container">
                        <h1 class="options-title text-center mb-4"><i class="fa-solid fa-cat"></i> Options </h1>
                        <form method="POST" action="/game" target="_blank" class="mt-2">
                            <div class="form-group mb-3">
                                <label class="form-label d-block mb-2">
                                    <i class="fa-solid fa-list-ol"></i> Nombre de choix par question
                                </label>
                                <input type="number" name="choices" value="{{ form_choices or '10' }}" min="2" max="15" class="form-control form-input choices-input" maxlength="3">
                            </div>
                            
                            <div class="form-group mb-3">
                                <label class="form-label d-block mb-2">
                                    <i class="fa-solid fa-clock"></i> Temps par question (sec)
                                </label>
                                <input type="number" name="Timer" value="{{ form_timer or '30' }}" min="10" max="90" class="form-control form-input">
                            </div>
                            
                            <div class="form-group mb-3">
                                <label class="form-label d-block mb-2">
                                    <i class="fa-solid fa-trophy"></i> Mode de fin de jeu
                                </label>
                                <select name="end_mode" class="form-control form-select">
                                    <option value="questions" {{ 'selected' if (form_end_mode or 'questions') == 'questions' else '' }}>Nombre de questions</option>
                                    <option value="points" {{ 'selected' if form_end_mode == 'points' else '' }}>Score maximum</option>
                                </select>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label class="form-label d-block mb-2">
                                    <i class="fa-solid fa-question"></i> Nombre total de questions
                                </label>
                                <input type="number" name="total" value="{{ form_total or '0' }}" min="0" max="100" class="form-control form-input">
                            </div>
                            
                            <div class="form-group mb-3" id="max_points_group" style="display: {{ 'block' if form_end_mode == 'points' else 'none' }};">
                                <label class="form-label d-block mb-2">
                                    <i class="fa-solid fa-star"></i> Score maximum à atteindre
                                </label>
                                <input type="number" name="max_points" value="{{ form_max_points or '500' }}" min="50" max="10000" class="form-control form-input">
                            </div>
                            
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" name="start" value="start" class="btn btn-primary start-button" {% if players|length == 0 %} disabled {%endif%}>
                                    <i class="fa-solid fa-play"></i> Go
                                </button>
                                <!-- Bouton visible temporairement pour test - normalement affiché seulement si game_state in ['loading', 'in_progress', 'paused'] -->
                                <button type="button" class="btn btn-danger" onclick="terminateGame()">
                                    <i class="fa-solid fa-stop"></i> Terminer le jeu
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Colonne de droite : Liste des joueurs -->
            <div class="col-8">
                <div class="players-panel p-4 border">
                    <h1><i class="fa-solid fa-users"></i> Liste des joueurs</h1>
                    {% if error %}
                      <div class="alert alert-danger" role="alert">
                        {{ error }}
                      </div>
                    {% endif %}
          <form method="POST" action="/addplayer" class="mb-4" id="addPlayerForm">
            <!-- Hidden inputs to preserve current options when adding a player -->
            <input type="hidden" name="choices" id="hidden_choices">
            <input type="hidden" name="Timer" id="hidden_timer">
            <input type="hidden" name="end_mode" id="hidden_end_mode">
            <input type="hidden" name="total" id="hidden_total">
            <input type="hidden" name="max_points" id="hidden_max_points">

            <div class="row align-items-end">
              <div class="col-8">
                <label for="player_name" class="form-label"><i class="fa-solid fa-user-plus"></i> Nom du joueur</label>
                <input id="player_name" name="player_name" type="text" class="form-control"/>
              </div>
              <div class="col-4">
                <button type="submit" name="addp" value="addp" class="btn btn-primary w-100">
                  <i class="fa-solid fa-plus"></i> Ajouter
                </button>
              </div>
            </div>
          </form>
                    <table class="table table-striped">
                        <thead>
                          <tr>
                            <th><i class="fa-solid fa-user"></i> Joueur</th>
                            <th><i class="fa-solid fa-star"></i> Score</th>
                            <th><i class="fa-solid fa-qrcode"></i> QR Code</th>
                            <th><i class="fa-solid fa-trash"></i> Supprimer</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for r in players %}
                          <tr>
                            <td>
                              <div class="d-flex align-items-center">
                                {% if r[2] %}
            <img src="{{ url_for('static', filename='avatars/' + r[2]) }}" 
              alt="Avatar" 
              class="player-avatar me-2" 
              data-player-name="{{ r[0] }}"
              style="width: 48px; height: 48px; border-radius: 50%; cursor: pointer;"
              title="Voir le profil de {{ r[0] }}"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
            <i class="fa-solid fa-user me-2" style="display: none; width: 48px; text-align: center;"></i>
                                {% else %}
            <i class="fa-solid fa-user me-2" style="width: 48px; text-align: center;"></i>
                                {% endif %}
                                <a href="/player/{{ r[0] }}" target="_blank" class="text-decoration-none">
                                  {{ r[0] }}
                                </a>
                                <span class="player-status-indicator ms-2" data-player-name="{{ r[0] }}" 
                                      title="{% if r[4] %}Actif{% else %}Inactif{% endif %}">
                                  <i class="fa-solid fa-circle" style="font-size: 10px; color: {% if r[4] %}#28a745{% else %}#dc3545{% endif %};"></i>
                                </span>
                              </div>
                            </td>
                            <td>{{ r[1] }}</td>
                            <td>
                                <a href="#" class="player-link" data-name="{{ r[0] }}" data-qr="static/players/{{ r[0] }}.svg" title="Voir le QR code de {{ r[0] }}">
                                   <span class="qr-bg">
                                      <img src="static/players/{{ r[0] }}.svg" alt="QR code">
                                  </span>
                                </a>
                            </td>
                            <td>
                              <form method="POST" action="/deleteplayer" class="delete-form">
                                <input type="hidden" name="player_name" value="{{ r[0] }}">
                                <button type="submit" class="btn btn-danger btn-sm" title="Supprimer {{ r[0] }}">
                                  <i class="fa-solid fa-trash"></i>
                                </button>
                              </form>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Card modal for player info -->
<div id="playerCard" class="card text-dark" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); min-width:450px; z-index:9999; max-width:550px;">
  <div class="card-header bg-primary text-white text-center">
    <span id="cardPlayerName" style="font-weight:bold; font-size:1.2rem;"></span>
    <span id="cardPlayerStatusIndex" class="ms-2" title="Status du joueur">
      <i class="fa-solid fa-circle" style="font-size: 10px;"></i>
    </span>
    <button type="button" class="btn-close btn-close-white float-end" aria-label="Close" onclick="closePlayerCard()"></button>
  </div>
  <div class="card-body text-center">
    <!-- Avatar et Score côte à côte -->
    <div class="row mb-4 align-items-center">
      <div class="col-6 text-center">
        <img id="cardPlayerAvatar" src="" alt="Avatar" style="width:120px; height:120px; border-radius:50%; border: 3px solid #0d6efd; object-fit: cover;">
        <i id="cardPlayerDefaultAvatar" class="fa-solid fa-user" style="display: none; font-size: 80px; color: #6c757d;"></i>
      </div>
      <div class="col-6">
        <div class="card bg-light h-100 d-flex justify-content-center align-items-center">
          <div class="card-body p-3 text-center">
            <h6 class="card-title mb-2 text-muted">Score</h6>
            <h2 class="text-primary mb-0" id="cardPlayerScore">0</h2>
          </div>
        </div>
      </div>
    </div>
    
    <!-- QR Code plus grand -->
    <div class="mb-2">
      <h6 class="text-muted mb-3">QR Code</h6>
      <div class="qr-bg d-inline-block">
        <img id="cardPlayerQR" src="" alt="Player QR code" style="width:200px; height:200px;">
      </div>
    </div>
  </div>
</div>
<div id="cardOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9998;" onclick="closePlayerCard()"></div>

<script>
  // Fonction pour afficher la carte du joueur
  function showPlayerCard(playerName, playerScore, playerAvatar, playerQR, isActive) {
    // Remplir les informations de la carte
    document.getElementById('cardPlayerName').textContent = playerName;
    document.getElementById('cardPlayerScore').textContent = playerScore;
    document.getElementById('cardPlayerQR').src = playerQR;
    
    // Update status indicator
    const statusIndicator = document.getElementById('cardPlayerStatusIndex');
    const statusIcon = statusIndicator.querySelector('i');
    statusIcon.style.color = isActive ? '#28a745' : '#dc3545';
    statusIndicator.title = isActive ? 'Actif' : 'Inactif';
    
    // Gérer l'avatar
    const avatarImg = document.getElementById('cardPlayerAvatar');
    const defaultAvatar = document.getElementById('cardPlayerDefaultAvatar');
    
    if (playerAvatar && playerAvatar !== '') {
      avatarImg.src = `/static/avatars/${playerAvatar}`;
      avatarImg.style.display = 'block';
      defaultAvatar.style.display = 'none';
      
      // Gérer le cas où l'image n'existe pas
      avatarImg.onerror = function() {
        this.style.display = 'none';
        defaultAvatar.style.display = 'block';
      };
    } else {
      avatarImg.style.display = 'none';
      defaultAvatar.style.display = 'block';
    }
    
    // Afficher la carte et l'overlay
    document.getElementById('playerCard').style.display = 'block';
    document.getElementById('cardOverlay').style.display = 'block';
  }

  // Ouvre la carte au clic sur le QR code
  document.querySelectorAll('.player-link').forEach(function(link){
    link.addEventListener('click', function(e){
      e.preventDefault();
      const playerName = this.dataset.name;
      const playerQR = this.dataset.qr;
      
      // Récupérer les informations du joueur depuis la ligne du tableau
      const row = this.closest('tr');
      const playerScore = row.cells[1].textContent.trim();
      
      // Récupérer l'avatar depuis l'image de la première cellule
      const avatarImg = row.querySelector('.player-avatar');
      const playerAvatar = avatarImg ? avatarImg.src.split('/').pop() : '';
      
      // Récupérer le statut depuis l'indicateur
      const statusIndicator = row.querySelector('.player-status-indicator i');
      const isActive = statusIndicator && statusIndicator.style.color === 'rgb(40, 167, 69)'; // #28a745 in RGB
      
      showPlayerCard(playerName, playerScore, playerAvatar, playerQR, isActive);
    });
  });

  // Ouvre la carte au clic sur l'avatar
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('player-avatar')) {
      e.preventDefault();
      const playerName = e.target.getAttribute('data-player-name');
      
      // Récupérer les informations du joueur depuis la ligne du tableau
      const row = e.target.closest('tr');
      const playerScore = row.cells[1].textContent.trim();
      const playerAvatar = e.target.src.split('/').pop();
      
      // Récupérer le QR code depuis le lien dans la même ligne
      const qrLink = row.querySelector('.player-link');
      const playerQR = qrLink ? qrLink.dataset.qr : '';
      
      // Récupérer le statut depuis l'indicateur
      const statusIndicator = row.querySelector('.player-status-indicator i');
      const isActive = statusIndicator && statusIndicator.style.color === 'rgb(40, 167, 69)'; // #28a745 in RGB
      
      showPlayerCard(playerName, playerScore, playerAvatar, playerQR, isActive);
    }
  });
  
  // Ferme la carte
  function closePlayerCard(){
    document.getElementById('playerCard').style.display = 'none';
    document.getElementById('cardOverlay').style.display = 'none';
  }

  document.getElementById('player_name').addEventListener('input', function() {
    const btn = document.querySelector('button[name="addp"]');
    btn.disabled = this.value.trim() === '';
});

  // Toggle max_points input based on end_mode selection
  document.querySelector('select[name="end_mode"]').addEventListener('change', function() {
    const maxPointsGroup = document.getElementById('max_points_group');
    const totalQuestionsInput = document.querySelector('input[name="total"]').closest('.form-group');
    
    if (this.value === 'points') {
      maxPointsGroup.style.display = 'block';
      totalQuestionsInput.style.display = 'none';
    } else {
      maxPointsGroup.style.display = 'none';
      totalQuestionsInput.style.display = 'block';
    }
  });

  // Preserve current options when submitting the add-player form
  const addPlayerForm = document.getElementById('addPlayerForm');
  if (addPlayerForm) {
    addPlayerForm.addEventListener('submit', function(e) {
      // copy current option values into hidden inputs
      const choices = document.querySelector('input[name="choices"]');
      const timer = document.querySelector('input[name="Timer"]');
      const endMode = document.querySelector('select[name="end_mode"]');
      const total = document.querySelector('input[name="total"]');
      const maxPoints = document.querySelector('input[name="max_points"]');

      const hChoices = document.getElementById('hidden_choices');
      const hTimer = document.getElementById('hidden_timer');
      const hEndMode = document.getElementById('hidden_end_mode');
      const hTotal = document.getElementById('hidden_total');
      const hMaxPoints = document.getElementById('hidden_max_points');

      if (hChoices && choices) hChoices.value = choices.value;
      if (hTimer && timer) hTimer.value = timer.value;
      if (hEndMode && endMode) hEndMode.value = endMode.value;
      if (hTotal && total) hTotal.value = total.value;
      if (hMaxPoints && maxPoints) hMaxPoints.value = maxPoints.value;
      // allow submit to proceed
    });
  }

  // Fonction pour terminer le jeu avec confirmation
  function terminateGame() {
    if (confirm('Êtes-vous sûr de vouloir terminer le jeu en cours ? Cette action est irréversible.')) {
      // Créer un formulaire invisible pour envoyer la requête POST
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/terminate_game';
      form.style.display = 'none';
      document.body.appendChild(form);
      form.submit();
    }
  }
  
  // Connect to Socket.IO for real-time player status updates
  var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
  
  socket.on('connect', function() {
    console.log('Connected to server for status updates');
  });
  
  // Listen for player status changes
  socket.on('player_status_changed', function(data) {
    const playerName = data.player_name;
    const isActive = data.is_active;
    const statusColor = isActive ? '#28a745' : '#dc3545';
    const statusTitle = isActive ? 'Actif' : 'Inactif';
    
    // Update all status indicators for this player
    document.querySelectorAll(`.player-status-indicator[data-player-name="${playerName}"]`).forEach(function(indicator) {
      const icon = indicator.querySelector('i');
      if (icon) {
        icon.style.color = statusColor;
        indicator.title = statusTitle;
      }
    });
    
    console.log(`Player ${playerName} status changed to: ${isActive ? 'ACTIVE' : 'INACTIVE'}`);
  });
</script>
</script>
</body>
</html>